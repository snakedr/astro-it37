<script client:load>
    // --- ЛОГИКА ЭФФЕКТА МАТРИЦЫ ---
    
    // !!! КРИТИЧЕСКОЕ ИЗМЕНЕНИЕ: ГАРАНТИРУЕМ, ЧТО HTML ГОТОВ !!!
    document.addEventListener('DOMContentLoaded', () => {

        const canvas = document.getElementById('matrixCanvas');
        if (!canvas) return; // Проверка 1: Элемент должен быть найден
        
        const context = canvas.getContext('2d');
        if (!context) return; // Проверка 2: Контекст рисования должен быть получен

        const dashboard = document.getElementById('dashboard-block');
        const matrixChars = '0123456789ABCDEFGHIJKLMNOPQRSTUVWXYZАБВГДЕЖЗИЙКЛМНОПРСТУФХЦЧШЩЪЫЬЭЮЯ!@#$%^&*()_+-=~`<>,.?/|{}[]';
        const fontSize = 16; 
        let drops = [];
        
        // 1. Установка размера Canvas по родительскому блоку
        const setCanvasSize = () => {
            if (dashboard) {
                canvas.width = dashboard.clientWidth;
                canvas.height = dashboard.clientHeight;
            }
        };

        // 2. Инициализация столбцов (drops)
        const initDrops = () => {
            setCanvasSize(); 
            const columns = Math.floor(canvas.width / fontSize);
            drops = [];
            for (let i = 0; i < columns; i++) {
                drops[i] = 1; 
            }
        };

        // 3. Функция отрисовки
        const drawMatrix = () => {
            // Отрисовка с полупрозрачным фоном для эффекта "хвоста"
            context.fillStyle = 'rgba(0, 0, 0, 0.05)'; 
            context.fillRect(0, 0, canvas.width, canvas.height);
            
            // Установка цвета и шрифта
            context.fillStyle = '#00f2ff'; 
            context.font = `${fontSize}px monospace`;

            // Проверяем, не изменился ли размер
            if (drops.length !== Math.floor(canvas.width / fontSize)) {
                initDrops(); 
            }
            
            // Отрисовка символов
            for (let i = 0; i < drops.length; i++) {
                const text = matrixChars.charAt(Math.floor(Math.random() * matrixChars.length));
                context.fillText(text, i * fontSize, drops[i] * fontSize);

                // Сброс колонки, когда она достигает дна
                if (drops[i] * fontSize > canvas.height && Math.random() > 0.975) {
                    drops[i] = 0; 
                }
                drops[i]++; 
            }
        };

        // Запускаем инициализацию и анимацию
        initDrops();
        setInterval(drawMatrix, 50); 
        
        // Обработка изменения размера окна
        window.addEventListener('resize', initDrops);

    }); // Конец DOMContentLoaded: Гарантирует запуск после HTML
</script>